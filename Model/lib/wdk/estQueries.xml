<wdkModel>

  <querySet name="EstIdQueries" queryType="id" isCacheable="true">
    
    <sqlQuery name="EstsByOrganismAbbrev">
      <paramRef ref="estParams.organismAbbrev"/>
      <column name="source_id"/>
      <sql>
        <![CDATA[
select ea.source_id
from apidbtuning.estattributes ea,
     apidbtuning.taxonspecies ts,
     sres.taxonname tn,
     apidb.organism o
where ea.organism = tn.name
and tn.taxon_id = ts.SPECIES_TAXON_ID
and ts.taxon_id = o.taxon_id
and o.IS_REFERENCE_STRAIN = 1
and o.ABBREV = $$organismAbbrev$$
        ]]>
      </sql>
    </sqlQuery>
  </querySet>

  <querySet name="EstParamQueries" queryType="vocab"  isCacheable="true">
    <sqlQuery name="organismAbbrevs">
      <column name="internal" />
      <column name="term" />
      <sql>
        <![CDATA[
          SELECT distinct o.abbrev AS internal, 
                          o.abbrev AS term
          FROM apidb.organism o
        ]]>
      </sql>
    </sqlQuery>

  </querySet>

  <paramSet name="estParams"> 
    <flatVocabParam name="organismAbbrev"
                    queryRef="EstParamQueries.organismAbbrevs"
                    multiPick="false"
                    prompt="Organism abbrev"
                    quote="true">
    </flatVocabParam>
  </paramSet>

  
  <querySet name="EstAttributeQueries" queryType="table" isCacheable="false">

    <sqlQuery name="Bfmv">
      <column name="source_id"/>
      <column name="dbest_name"  ignoreCase="true"/>
      <column name="vector"  ignoreCase="true"/>
      <column name="stage"  ignoreCase="true"/>
      <sql>
        <![CDATA[
          select bfmv.source_id, bfmv.dbest_name, bfmv.vector, bfmv.stage
          from apidbTuning.EstAttributes bfmv
        ]]>
      </sql>
    </sqlQuery>

  </querySet>
  
  <querySet name="EstTableQueries" queryType="table" isCacheable="false">

    <sqlQuery name="EstAlias" doNotTest="true">
      <column name="source_id"/>
      <column name="old_source_id"/>
      <sql>
        <![CDATA[
          select source_id, source_id as old_source_id,
          from ApidbTuning.EstAttributes
        ]]>
      </sql>
    </sqlQuery>

    <sqlQuery name="Reference" excludeProjects="EuPathDB">
      <column name="source_id" />
      <column name="author" />
      <column name="affiliation" />
      <sql>
        <![CDATA[
          select e.accession as source_id,
                 case when (c.name is not null) then c.name else c.last end as author,
                 c.address1 as affiliation
          from dots.Est e, sres.Contact c,
               dots.ExternalNaSequence ens, sres.OntologyTerm ot
          where e.contact_id = c.contact_id
            and ens.na_sequence_id = e.na_sequence_id
            and ens.sequence_ontology_id = ot.ontology_term_id
            and ot.name = 'EST'
        ]]>
      </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
