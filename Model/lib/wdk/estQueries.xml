<wdkModel>

  <querySet name="EstIdQueries" queryType="id" isCacheable="true">
    
    <sqlQuery name="EstsByOrganismAbbrev">
      <paramRef ref="estParams.organismAbbrev"/>
      <column name="source_id"/>
      <sql>
        <![CDATA[
select ea.source_id
from apidbtuning.estattributes ea,
     apidbtuning.taxonspecies ts,
     sres.taxonname tn,
     apidb.organism o
where ea.organism = tn.name
and tn.taxon_id = ts.SPECIES_TAXON_ID
and ts.taxon_id = o.taxon_id
and o.IS_REFERENCE_STRAIN = 1
and o.ABBREV = '$$organismAbbrev$$'
        ]]>
      </sql>
    </sqlQuery>
  </querySet>

  <querySet name="EstParamQueries" queryType="vocab"  isCacheable="true">
    <sqlQuery name="organismAbbrevs">
            <column name="internal" />
            <column name="term" />
            <sql>
        <![CDATA[
		SELECT distinct o.abbrev AS internal, 
                         o.abbrev AS term
                         FROM apidb.organism o
        ]]>
            </sql>
       </sqlQuery>

  </querySet>

  <paramSet name="estParams"> 
    <flatVocabParam name="organismAbbrev"
                    queryRef="EstParamQueries.organismAbbrevs"
                    prompt="Organism abbrev"
                    quote="true">
    </flatVocabParam>
  </paramSet>

  
  <querySet name="EstAttributeQueries" queryType="table" isCacheable="false">

    <sqlQuery name="Bfmv">
            <column name="source_id"/>
            <column name="dbest_name"  ignoreCase="true"/>
            <column name="vector"  ignoreCase="true"/>
            <column name="stage"  ignoreCase="true"/>
            <sql>
            <![CDATA[
           SELECT bfmv.source_id, bfmv.project_id, lower(bfmv.project_id) as project_id_lc, bfmv.primer, bfmv.a_count,  bfmv.c_count, 
                  bfmv.g_count, bfmv.t_count, bfmv.other_count, bfmv.length, 
                  bfmv.dbest_name, bfmv.vector, bfmv.stage,
                  CASE bfmv.organism when 'Giardia intestinalis' THEN 'Giardia lamblia' else bfmv.organism END as organism_text,
                  bfmv.ncbi_tax_id,
                  '<i>' || SUBSTR(bfmv.organism, 1, 1) || '.' ||
                  REGEXP_REPLACE(SUBSTR(CASE bfmv.organism when 'Giardia intestinalis' THEN 'Giardia lamblia' else bfmv.organism END, INSTR(bfmv.organism, ' ')), '[[:space:]]+',
                                 chr(38) || 'nbsp;') || '</i>'
                    AS formatted_organism,
                  bfmv.external_db_name
            FROM  ApidbTuning.EstAttributes bfmv
            ]]>
           </sql>
        </sqlQuery>

  </querySet>
  
  <querySet name="EstTableQueries" queryType="table" isCacheable="false">

    <sqlQuery name="EstAlias" doNotTest="true">
            <column name="source_id"/>
            <column name="old_source_id"/>
            <sql>
              <![CDATA[
                SELECT source_id, 
                       source_id as old_source_id,
                FROM ApidbTuning.EstAttributes
              ]]>
            </sql>
        </sqlQuery>

        <sqlQuery name="Reference" excludeProjects="EuPathDB">
            <column name="source_id" />
            <column name="author" />
            <column name="affiliation" />
            <sql>
            <![CDATA[
            SELECT e.accession as source_id, ea.project_id,
                   CASE WHEN (c.name IS NOT NULL) THEN c.name ELSE c.last END AS author,
                   c.address1 as affiliation,
                   c.address2 as address
            FROM dots.est e, sres.contact c, 
                 dots.externalnasequence ens, sres.ontologyTerm ot, apidbtuning.estattributes ea
            WHERE e.contact_id = c.contact_id
            and  e.accession = ea.source_id
            and ens.na_sequence_id = e.na_sequence_id
            and ens.sequence_ontology_id = ot.ontology_term_id
            and ot.name = 'EST'
            ]]>
            </sql>
        </sqlQuery>

        
    </querySet>


</wdkModel>
